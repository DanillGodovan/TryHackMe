- What is malware?
- How to start analyzing a malware
- Static and Dynamic malware analysis
- Resources to help you analyze malware

# Malware Analysis (Task 2)

### Groups, who need a Malware Analysis:

- Security Operations (SOC) to write detection for malicious activity
- Incident Response (IR) to determine what damage has been done to an environment and later revert that damage
- Threat Hunt teams to identify IOC (Indicator of Compromise), which used to hunt for malware in a network
- Malware Researchers in security product vendor teams to add detections for them and their products
- Threat Research to discover the vulnerabilities exploited with malware and add more security features to the OS/Applications

### Common points before analyzing it:

- The analysis machine has to have purpose to **ONLY** analyze malware provided to it
- Keep the malware in password-protected archive to avoid accidental detonation
- Only extract it when analysing it
- Create an isolated VM specifically for malware analysis, the main condition is to be able to revert it to the clean state once you done
- Close internet connections to prevent spreading of malware. (Or atleast monitor them)
- After analysis revert the system (VM) to the clean state

### Questions:

Which team uses malware analysis to look for IOCs and hunt for malware in a network?
**Answer:** Threat Hunt team

# Techniques of malware analysis (Task 3)

- Malware is mostly a portable executable (**PE**) file, **PCAP** or malicious document file.
- Most of techniques can be divided into 2 categories: **Static** and **Dynamic** Analysis

### Static Analysis

It's the term to analyse malware without executing or running it. That can be done by exploring properties of the PE file, checking strings in malware, PE Header or disassemble of code.
As opposed to malware uses various techniques to avoid it ->

- Obfuscation
- Packing
  To circumvent these techniques we use **Dynamic** Analysis.

### Dynamic Analysis

- These matters helps to avoid detection but once the malware is running, it becomes easy detectable
  Actions being done by Dynamic Analysis:
- Using VM to test the malware
- Monitor the malware activity with manual tools
- Use sandboxes to automate it
- Windows or Linux Forensics to investigate further actions on the system

Adversaries are trying to avoid this by detecting the environment which it is being run and if it's the incident it uses different code to intervent the analysis

### Advanced Malware Analysis

It's being used if **Static** and **Dynamic** Analysis are being evaded. It's done by using disassemblers and debuggers.

- Disassemblers are converting binary code to assebly so that analyst can look at this instructions statically.
- Debuggers attach to a programm and allow the analyst to monitor the instruction in malware while it is running. The analyst can use different points to see the actions malware doing. It provides overview of memore and CPU of the system

### Questions

1. Which technique is used for analyzing malware without executing it?
   **Answer**: Static Analysis
2. Which technique is used for analyzing malware by executing it and observing its behavior in a controlled environment?
   **Answer:** Dynamic Analysis

# Basic Static Analysis (Task 4)

For this task we use an attached machine.

#### File

We need to examine the file type to not get fooled by the shown one. Therefore we use **`file`** command

```sh
user@machine$ file wannacry
wannacry: PE32 executable (GUI) Intel 80386, for MS Windows
user@machine$
```

P.S. 80386 is the first architecture that is still used, therefore the name of architecture is x86 (803**86**)
for 32-bit systems.

#### Strings

This command shows string present in a file.

```sh
user@machine$ strings <filename>
```

It could be helpful as we typical `DOS Stub` - "!This program cannot be run in DOS mode."
or it could show common libraries or Windows APIs used in this program
Example: WannaDecryptor

```sh
user@machine$ strings wannacry
- unzip 0.15 Copyright 1998 Gilles Vollant
inflate 1.1.3 Copyright 1995-1998 Mark Adler
CloseHandle --------------
GetExitCodeProcess       |
TerminateProcess         | Common Windows API calls
WaitForSingleObject      |
CreateProcessA           |
GlobalFree ---------------
```

#### Calculating hashes

File Hashing gives us a fixed-size unique number that identifies a file. Hashing gives us one of the CIA triade - Integrity. We can use it as an identifier for specific malware that was already used and search for it

Common commands that can be used -> md5sum, sha1sum, sha256sum

### Questions:

1. In the attached VM, there is a sample named 'redline' in the Desktop/Samples directory. What is the md5sum of this sample?
   **Answer:** ca2dc5a3f94c4f19334cc8b68f256259
2. What is the creation time of this sample?
   We need to look at Virustotal using the md5 hash. The answer is in details
   **Answer:** 2020-08-01 02:44:18 UTC

# The PE file Header (Task 5)

-> contains the metadata about a Portable Executable (PE) file. This can help in further investigation of malicious file

#### Imports / Exports

A PE file seldom contains all code that it needs to run on a system on its own. Most of the time it re-uses the code provided by the OS. It is easier when user wants to Query a Windoes Registry value, they will import the ReqQueryValue by Microsoft instead of writing their own. Exports is more used with **Dynamically-Linked Libraries** (DLL)and it is not typical for a non-DLL PE file to have a lot of exports.

_Own exploration: the malware may have these coded to avoid finding imports_

#### Sections

A **PE** file is divided into different sections with different purposes. The most common sections are:

- .text: CPU instructions to run. Often marked as executable
- .data: global variables
- .rsrc: resources that used by PE file, example: images, icons, etc.

#### Analyzing PE header using pecheck

Here we can see information pecheck has extracted from the PE header of the wannacry sample. We see that the sample has 4 sections, .text, .rdata, .data and .rsrc and their respective entropy. Similarly, it has also shown us the different hashes of the sample. Pecheck also shows us the functions that a PE file imports. In the above terminal window, we can see the IMAGE_IMPORT_DESCRIPTOR, which shows the functions it imports from the ADVAPI32.dll Linked library. We will see similar descriptors for all the other linked libraries whose functions are imported by the sample.

```sh
user@machine$ pecheck wannacry
PE check for 'wannacry':
Entropy: 7.995471 (Min=0.0, Max=8.0)
MD5 hash: 84c82835a5d21bbcf75a61706d8ab549
SHA-1 hash: 5ff465afaabcbf0150d1a3ab2c2e74f3a4426467
SHA-256 hash: ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa
SHA-512 hash: 90723a50c20ba3643d625595fd6be8dcf88d70ff7f4b4719a88f055d5b3149a4231018ea30d375171507a147e59f73478c0c27948590794554d031e7d54b7244
.text entropy: 6.404235 (Min=0.0, Max=8.0)
.rdata entropy: 6.663571 (Min=0.0, Max=8.0)
.data entropy: 4.455750 (Min=0.0, Max=8.0)
.rsrc entropy: 7.999868 (Min=0.0, Max=8.0)
```

# Basic Dynamic Analysis (Task 6)

As before, this type of analysis is needed for detecting malware behavior by **RUNNING** it.

#### Introduction to Sandboxes

-> place, where dry runs take place and identify possible outcomes. It's an isolated environment that mimic actual target environment of a malaware, where an analyst runs a sample.

#### Construction of a sandbox

- Virtual Machine mimicking the actual target environment of the malware sample
- Ability to take snapshots and revert to clean state
- OS monitoring software, for example, Procmon, ProcExplorer or Regshot, etc.
- Network monitoring software, for example, Wireshark, tcpdump, etc.
- Control over the network through a dummy DNS server and webserver.
- A mechanism to move analysis logs and malware samples in and out of the Virtual Machine without compromising the host (Be careful with this one. If you have a shared directory with your malware analysis VM that remains accessible when running malware, you might risk malware affecting all files in your shared directory)

#### Various open source sandboxes

- Cuckoo's Sandbox -> Easy documentation and lots of customizations, however doesn't support Python3
- Online Sandboxes: Online Cuckoo Sandbox, Any.run, Intezer, Hybrid Analysis
  The first valid step is to submit a hash or any known info about malware as maybe someone had already analysed it.
  This sandboxes often have a details about techniques used in MITRE ATT&CK Framework which can be viewed.

#### Questions

1. Check the hash of the sample 'redline' on Hybrid analysis and check out the hybrid analysis report. In the process tree, which is the first process launched when the sample is launched?
   **Answer:** First of all we get the hash of redline

```sh
ubuntu@ip-10-10-194-199:~/Desktop/Samples$ md5sum redline
ca2dc5a3f94c4f19334cc8b68f256259  redline
```

    Afterwards we need to search this hash on https://hybrid-analysis.com/
    Found this one: https://hybrid-analysis.com/sample/e8ba49a75de083cb786e8ed84972affa11542dd913f1a07b0d44e1d45e5e22e9/64fca500fc4906843d04068e
    We use it for further analysis of process tree:
    setup_installer.exe (PID: 3900) 41/70 -> the answer

2. In the process tree, there are two Windows utilities utilized by the malware to perform its activities. What are the names of the two utilities? (Format: utility1.exe and utility2.exe)
   **Answer:** We look in this tree further and see this lines:

```powershell
- cmd.exe %WINDIR%\system32\cmd.exe /c powershell -inputformat none -outputformat none -NonInteractive -Command Add-MpPreference -ExclusionPath "%TEMP%\ (PID: 2712)
- powershell.exe powershell -inputformat none -outputformat none -NonInteractive -Command Add-MpPreference -ExclusionPath "%TEMP%\ (PID: 7528)
```

    Also, the used Windows utilities are cmd.exe and powershell.exe

# Anti-analysis techniques (Task 7)

#### Packing and Obfuscation:

Packer tries to compress, encrypt or obfuscate the contents of malware. This approach helps him to hide the significant information about the malware by adding garbage strings that mix things up.

#### Sandbox evasion:

That can be achieved by following techniques:

- Long sleep calls -> Sandbox are limited by time, therefore they try to avoid it by adding more time than expected
- User activity detection -> in Sandbox there's no any user activity such as mouse movement or keyboard input
- Footprinting user activity -> Checking for MS Office history or internet browsing history to check if user was present
- Detecting VMs -> VMs are leaving artifacts that can be detected by the malware

#### Questions:

1. Which of the techniques discussed above is used to bypass static analysis?
   **Answer:** Packing
2. Which technique discussed above is used to time out a sandbox?
   **Answer:** Long Sleep Calls
